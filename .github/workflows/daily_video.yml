name: Daily Tech News Generator

on:
  schedule:
    # Run every 4 hours throughout the day (6 times per day)
    # Times: 00:00, 04:00, 08:00, 12:00, 16:00, 20:00 UTC
    - cron: '0 */4 * * *' # Every 4 hours
  workflow_dispatch:

jobs:
  build-and-post:
    runs-on: ubuntu-latest
    permissions:
      contents: write  # Required to commit and push covered_stories.json

    steps:
      - name: Checkout Repository
        uses: actions/checkout@v4
        with:
          persist-credentials: true  # Required to push commits back to the repository

      - name: Install System Dependencies
        run: |
          sudo apt-get update
          sudo apt-get install -y ffmpeg imagemagick
          sudo sed -i 's/none/read,write/g' /etc/ImageMagick-6/policy.xml

      - name: Set up Python
        uses: actions/setup-python@v5
        with:
          python-version: '3.10'

      - name: Install Python Dependencies
        run: pip install -r requirements.txt

      - name: Download NLTK Data
        run: |
          python -c "import nltk; nltk.download('punkt_tab', quiet=True)"

      - name: Setup Google Cloud Credentials
        run: |
          python3 << 'EOF'
          import os
          import json
          import sys
          
          creds_secret = os.environ.get('GOOGLE_APPLICATION_CREDENTIALS_SECRET', '')
          
          if creds_secret:
              try:
                  # Validate it's valid JSON
                  json.loads(creds_secret)
                  # Write to file
                  creds_path = os.path.expanduser('~/gcloud_credentials.json')
                  with open(creds_path, 'w') as f:
                      f.write(creds_secret)
                  os.chmod(creds_path, 0o600)
                  print(f"Credentials file created at {creds_path}")
                  print(f"File size: {os.path.getsize(creds_path)} bytes")
                  # Set environment variable for next step
                  github_env = os.environ.get('GITHUB_ENV')
                  if github_env:
                      with open(github_env, 'a') as f:
                          f.write(f"GCLOUD_CREDS_PATH={creds_path}\n")
              except json.JSONDecodeError as e:
                  print(f"ERROR: Invalid JSON in GOOGLE_APPLICATION_CREDENTIALS secret: {e}")
                  sys.exit(1)
          else:
              print("GOOGLE_APPLICATION_CREDENTIALS secret is empty or not set")
          EOF
        env:
          GOOGLE_APPLICATION_CREDENTIALS_SECRET: ${{ secrets.GOOGLE_APPLICATION_CREDENTIALS }}

      - name: Run Tech News Pipeline
        env:
          YT_CLIENT_ID: ${{ secrets.YT_CLIENT_ID }}
          YT_CLIENT_SECRET: ${{ secrets.YT_CLIENT_SECRET }}
          YT_REFRESH_TOKEN: ${{ secrets.YT_REFRESH_TOKEN }}
          YT_CHANNEL_NAME: ${{ secrets.YT_CHANNEL_NAME }}  # Optional: Channel name or handle (default: "Code Rush")
          TIKTOK_CLIENT_KEY: ${{ secrets.TIKTOK_CLIENT_KEY }}
          TIKTOK_CLIENT_SECRET: ${{ secrets.TIKTOK_CLIENT_SECRET }}
          TIKTOK_ACCESS_TOKEN: ${{ secrets.TIKTOK_ACCESS_TOKEN }}
          PEXELS_API_KEY: ${{ secrets.PEXELS_API_KEY }}  # Optional: for stock media fallback
          PIXABAY_API_KEY: ${{ secrets.PIXABAY_API_KEY }}  # Optional: for stock media fallback
          UNSPLASH_API_KEY: ${{ secrets.UNSPLASH_API_KEY }}  # Optional: for stock media fallback
          GEMINI_API_KEY: ${{ secrets.GEMINI_API_KEY }}  # Required: for script generation
          GOOGLE_APPLICATION_CREDENTIALS: ${{ env.GCLOUD_CREDS_PATH }}  # Path to credentials file (set in previous step)
          # TTS Voice Configuration (Google Cloud TTS - Primary):
          # GCLOUD_TTS_VOICE: Voice name (default: "Achird" for Chirp3-HD)
          #   - Chirp3-HD voices: "Achird", "Aurora", "Charon", "Fenrir", "Kore", "Puck", "Rhea", "Triton"
          #   - Neural2 voices: "en-US-Neural2-D" (male), "en-US-Neural2-F" (female), etc.
          #   - See: https://cloud.google.com/text-to-speech/docs/voices
          GCLOUD_TTS_VOICE: ${{ secrets.GCLOUD_TTS_VOICE }}  # Optional: TTS voice name (default: Achird)
          # GCLOUD_TTS_LANGUAGE: Language/locale code (default: "en-US")
          #   Examples: "en-US" (English US), "en-GB" (English UK), "es-ES" (Spanish), "fr-FR" (French), "de-DE" (German)
          #   Must match the voice's language. For Chirp3-HD voices, use "en-US"
          GCLOUD_TTS_LANGUAGE: ${{ secrets.GCLOUD_TTS_LANGUAGE }}  # Optional: Language/locale code (default: en-US)
          # TTS Voice Configuration (Edge-TTS - Fallback):
          # TTS_VOICE: Edge-TTS voice name (default: "en-US-AriaNeural")
          #   Examples: "en-US-AriaNeural", "en-GB-SoniaNeural", "es-ES-ElviraNeural"
          #   See: https://github.com/rany2/edge-tts/blob/master/edge_tts/list_voices.py
          TTS_VOICE: ${{ secrets.TTS_VOICE }}  # Optional: Edge-TTS voice (fallback, default: en-US-AriaNeural)
          GEMINI_MODEL: ${{ secrets.GEMINI_MODEL }}  # Optional: Gemini model (default: gemini-pro)
          USE_GEMINI: ${{ secrets.USE_GEMINI }}  # Optional: Enable Gemini (default: true)
          USE_GCLOUD_TTS: ${{ secrets.USE_GCLOUD_TTS }}  # Optional: Enable Google Cloud TTS (default: true)
        run: python bot.py

      - name: Commit and Push Covered Stories Log
        if: always()  # Run even if previous step failed
        run: |
          git config --local user.email "action@github.com"
          git config --local user.name "GitHub Action"
          
          # Check if covered_stories.json exists and has changes
          if [ -f "artifacts/covered_stories.json" ]; then
            echo "Found covered_stories.json, checking for changes..."
            git add artifacts/covered_stories.json
            
            # Check if there are staged changes
            if ! git diff --staged --quiet; then
              echo "Changes detected in covered_stories.json, committing..."
              git commit -m "Update covered stories log [skip ci]"
              
              # Attempt to push with retry logic
              max_retries=3
              retry_count=0
              while [ $retry_count -lt $max_retries ]; do
                if git push; then
                  echo "Successfully pushed covered_stories.json"
                  break
                else
                  retry_count=$((retry_count + 1))
                  if [ $retry_count -lt $max_retries ]; then
                    echo "Push failed, retrying in 5 seconds... (attempt $retry_count/$max_retries)"
                    sleep 5
                    # Fetch latest changes before retrying
                    git pull --rebase || true
                  else
                    echo "ERROR: Failed to push covered_stories.json after $max_retries attempts"
                    exit 1
                  fi
                fi
              done
            else
              echo "No changes to covered_stories.json"
            fi
          else
            echo "WARNING: covered_stories.json not found at artifacts/covered_stories.json"
            echo "This may indicate the bot did not save any stories, or the file path is incorrect"
          fi

