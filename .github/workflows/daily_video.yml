name: Daily Tech News Generator

on:
  schedule:
    - cron: '0 20 * * *' # 8 PM UTC
  workflow_dispatch:

jobs:
  build-and-post:
    runs-on: ubuntu-latest

    steps:
      - name: Checkout Repository
        uses: actions/checkout@v4

      - name: Install System Dependencies
        run: |
          sudo apt-get update
          sudo apt-get install -y ffmpeg imagemagick
          sudo sed -i 's/none/read,write/g' /etc/ImageMagick-6/policy.xml

      - name: Set up Python
        uses: actions/setup-python@v5
        with:
          python-version: '3.10'

      - name: Install Python Dependencies
        run: pip install -r requirements.txt

      - name: Download NLTK Data
        run: |
          python -c "import nltk; nltk.download('punkt_tab', quiet=True)"

      - name: Setup Google Cloud Credentials
        run: |
          python3 << 'EOF'
          import os
          import json
          import sys
          
          creds_secret = os.environ.get('GOOGLE_APPLICATION_CREDENTIALS_SECRET', '')
          
          if creds_secret:
              try:
                  # Validate it's valid JSON
                  json.loads(creds_secret)
                  # Write to file
                  creds_path = os.path.expanduser('~/gcloud_credentials.json')
                  with open(creds_path, 'w') as f:
                      f.write(creds_secret)
                  os.chmod(creds_path, 0o600)
                  print(f"Credentials file created at {creds_path}")
                  print(f"File size: {os.path.getsize(creds_path)} bytes")
                  # Set environment variable for next step
                  github_env = os.environ.get('GITHUB_ENV')
                  if github_env:
                      with open(github_env, 'a') as f:
                          f.write(f"GCLOUD_CREDS_PATH={creds_path}\n")
              except json.JSONDecodeError as e:
                  print(f"ERROR: Invalid JSON in GOOGLE_APPLICATION_CREDENTIALS secret: {e}")
                  sys.exit(1)
          else:
              print("GOOGLE_APPLICATION_CREDENTIALS secret is empty or not set")
          EOF
        env:
          GOOGLE_APPLICATION_CREDENTIALS_SECRET: ${{ secrets.GOOGLE_APPLICATION_CREDENTIALS }}

      - name: Run Tech News Pipeline
        env:
          YT_CLIENT_ID: ${{ secrets.YT_CLIENT_ID }}
          YT_CLIENT_SECRET: ${{ secrets.YT_CLIENT_SECRET }}
          YT_REFRESH_TOKEN: ${{ secrets.YT_REFRESH_TOKEN }}
          YT_CHANNEL_NAME: ${{ secrets.YT_CHANNEL_NAME }}  # Optional: Channel name or handle (default: "Code Rush")
          TIKTOK_CLIENT_KEY: ${{ secrets.TIKTOK_CLIENT_KEY }}
          TIKTOK_CLIENT_SECRET: ${{ secrets.TIKTOK_CLIENT_SECRET }}
          TIKTOK_ACCESS_TOKEN: ${{ secrets.TIKTOK_ACCESS_TOKEN }}
          PEXELS_API_KEY: ${{ secrets.PEXELS_API_KEY }}  # Optional: for stock media fallback
          PIXABAY_API_KEY: ${{ secrets.PIXABAY_API_KEY }}  # Optional: for stock media fallback
          UNSPLASH_API_KEY: ${{ secrets.UNSPLASH_API_KEY }}  # Optional: for stock media fallback
          GEMINI_API_KEY: ${{ secrets.GEMINI_API_KEY }}  # Required: for script generation
          GOOGLE_APPLICATION_CREDENTIALS: ${{ env.GCLOUD_CREDS_PATH }}  # Path to credentials file (set in previous step)
          GCLOUD_TTS_VOICE: ${{ secrets.GCLOUD_TTS_VOICE }}  # Optional: TTS voice name (default: en-US-Neural2-D)
          GEMINI_MODEL: ${{ secrets.GEMINI_MODEL }}  # Optional: Gemini model (default: gemini-pro)
          USE_GEMINI: ${{ secrets.USE_GEMINI }}  # Optional: Enable Gemini (default: true)
          USE_GCLOUD_TTS: ${{ secrets.USE_GCLOUD_TTS }}  # Optional: Enable Google Cloud TTS (default: true)
        run: python bot.py

